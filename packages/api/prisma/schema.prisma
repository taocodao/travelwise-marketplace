// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE MODELS (Enhanced)
// ============================================

model Agent {
  id            String   @id @default(uuid())
  onChainId     Int      @unique
  name          String
  walletAddress String   @unique
  metadataUri   String
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  mcpServers    MCPServer[]
  executions    Execution[]
  
  @@index([walletAddress])
  @@index([onChainId])
}

model MCPServer {
  id              String   @id @default(uuid())
  agentId         String
  name            String
  description     String
  endpoint        String
  walletAddress   String?
  totalEarnings   Decimal  @default(0) @db.Decimal(18, 6)
  callCount       Int      @default(0)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  tools           Tool[]
  executions      Execution[]
  transactions    Transaction[]
  toolCalls       MCPToolCall[]

  @@unique([walletAddress])
  @@index([agentId])
  @@index([endpoint])
  @@index([walletAddress])
}

model Tool {
  id           String   @id @default(uuid())
  mcpServerId  String
  name         String
  description  String
  baseCost     Decimal  @db.Decimal(10, 6)
  inputSchema  Json
  outputSchema Json?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  mcpServer    MCPServer @relation(fields: [mcpServerId], references: [id], onDelete: Cascade)
  executions   Execution[]
  toolCalls    MCPToolCall[]

  @@unique([mcpServerId, name])
  @@index([mcpServerId])
}

model Execution {
  id              String   @id @default(uuid())
  agentId         String
  mcpServerId     String
  toolId          String
  input           Json
  output          Json?
  baseCost        Decimal  @db.Decimal(10, 6)
  margin          Decimal  @db.Decimal(10, 6)
  totalCost       Decimal  @db.Decimal(10, 6)
  paymentTxHash   String?
  paymentStatus   PaymentStatus @default(PENDING)
  executionStatus ExecutionStatus @default(PENDING)
  errorMessage    String?
  startedAt       DateTime @default(now())
  completedAt     DateTime?
  createdAt       DateTime @default(now())

  agent           Agent    @relation(fields: [agentId], references: [id])
  mcpServer       MCPServer @relation(fields: [mcpServerId], references: [id])
  tool            Tool     @relation(fields: [toolId], references: [id])
  transaction     Transaction? @relation(fields: [paymentTxHash], references: [txHash])

  @@index([agentId])
  @@index([paymentTxHash])
  @@index([paymentStatus])
}

model PricingConfig {
  id            String   @id @default(uuid())
  marginPercent Decimal  @default(20) @db.Decimal(5, 2)
  platformFee   Decimal  @default(1) @db.Decimal(5, 2)
  updatedAt     DateTime @updatedAt
  updatedBy     String

  @@map("pricing_config")
}

model WalletConfig {
  id             String   @id @default(uuid())
  operatorWallet String   @unique
  escrowContract String
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("wallet_config")
}

// ============================================
// BLOCKCHAIN INTEGRATION MODELS
// ============================================

model User {
  id            String        @id @default(uuid())
  walletAddress String        @unique
  balance       Decimal       @default(0) @db.Decimal(18, 6)
  nonce         Int           @default(0)
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  transactions  Transaction[]
  toolCalls     MCPToolCall[]
  
  @@index([walletAddress])
  @@map("users")
}

model Transaction {
  id              String   @id @default(uuid())
  txHash          String   @unique
  blockNumber     Int?
  blockTimestamp  DateTime?
  from            String
  to              String
  amount          Decimal  @db.Decimal(18, 6)
  tokenAddress    String
  toolName        String?
  mcpServerId     String?
  description     String
  status          TransactionStatus @default(PENDING)
  gasUsed         String?
  gasPrice        String?
  chainId         Int      @default(84532)
  userId          String?
  timestamp       DateTime @default(now())
  confirmedAt     DateTime?
  
  user            User?     @relation(fields: [userId], references: [id])
  mcpServer       MCPServer? @relation(fields: [mcpServerId], references: [id])
  executions      Execution[]
  toolCalls       MCPToolCall[]
  
  @@index([txHash])
  @@index([from])
  @@index([to])
  @@index([userId])
  @@index([mcpServerId])
  @@index([status])
  @@index([blockNumber])
  @@map("transactions")
}

model MCPToolCall {
  id              String   @id @default(uuid())
  toolId          String
  toolName        String
  mcpServerId     String
  userId          String?
  transactionId   String?
  executionId     String?
  requestData     Json
  responseData    Json?
  cost            Decimal  @db.Decimal(10, 6)
  executionTime   Int?
  success         Boolean  @default(true)
  errorMessage    String?
  errorCode       String?
  timestamp       DateTime @default(now())
  
  tool            Tool     @relation(fields: [toolId], references: [id])
  mcpServer       MCPServer @relation(fields: [mcpServerId], references: [id])
  user            User?    @relation(fields: [userId], references: [id])
  transaction     Transaction? @relation(fields: [transactionId], references: [id])
  
  @@index([toolId])
  @@index([mcpServerId])
  @@index([userId])
  @@index([transactionId])
  @@index([timestamp])
  @@map("mcp_tool_calls")
}

model BlockchainEvent {
  id              String   @id @default(uuid())
  eventType       String
  contractAddress String
  txHash          String
  blockNumber     Int
  logIndex        Int
  eventData       Json
  processed       Boolean  @default(false)
  processedAt     DateTime?
  createdAt       DateTime @default(now())
  
  @@unique([txHash, logIndex])
  @@index([contractAddress])
  @@index([eventType])
  @@index([processed])
  @@index([blockNumber])
  @@map("blockchain_events")
}

model PaymentBatch {
  id              String   @id @default(uuid())
  batchTxHash     String   @unique
  userId          String
  totalAmount     Decimal  @db.Decimal(18, 6)
  itemCount       Int
  status          TransactionStatus @default(PENDING)
  items           Json
  createdAt       DateTime @default(now())
  processedAt     DateTime?
  
  @@index([userId])
  @@index([status])
  @@map("payment_batches")
}

model ServerAnalytics {
  id              String   @id @default(uuid())
  mcpServerId     String
  date            DateTime @db.Date
  totalCalls      Int      @default(0)
  successfulCalls Int      @default(0)
  failedCalls     Int      @default(0)
  totalRevenue    Decimal  @default(0) @db.Decimal(18, 6)
  avgResponseTime Int?
  uniqueUsers     Int      @default(0)
  createdAt       DateTime @default(now())
  
  @@unique([mcpServerId, date])
  @@index([mcpServerId])
  @@index([date])
  @@map("server_analytics")
}

// ============================================
// ENUMS
// ============================================

enum PaymentStatus {
  PENDING
  AUTHORIZED
  SETTLED
  REFUNDED
  FAILED
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum TransactionStatus {
  PENDING
  CONFIRMING
  CONFIRMED
  FAILED
  REVERTED
}
